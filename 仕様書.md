# ゴールデンクロス戦略Bot 要件定義書（ドラフト）

## 1. 背景・目的
本システムは、暗号資産 **XRP/JPY** の1時間足データを対象としたゴールデンクロス（短期SMAと長期SMAのクロス）戦略を自動化するものである。  
バックテストで検証済みの戦略を実運用に移行し、**自動売買・損益管理・通知・再現性**を確保することを目的とする。

---

## 2. 前提条件
- 取引所：bitFlyer（現物取引、API利用）  
- 銘柄：XRP/JPY  
- 時間足：1時間足  
- 戦略ルール：  
  - **エントリー**：短期SMAが長期SMAを上抜け（GC）した際に買い  
  - **決済**：エントリー価格から +2% で利確、-3% で損切り  
- 運用モード：  
  - **Paper Trading**（内部約定）  
  - **Real Trading**（実注文）  
- 通知：Slack（Webhook）  
- 状態管理：`state.json` に保存（再起動耐性）

---

## 3. 機能要件

### 3.1 データ取得
- 取引所APIから直近200本の1時間足データを取得  
- UTCベースの取得、内部処理は JST で統一  
- 取得データをCSV/Parquet形式でログ保存  

### 3.2 シグナル判定
- 短期SMA（30）と長期SMA（60）を計算  
- 直近「確定足」でGCを判定（未確定足は対象外）  
- 同一クロスの多重検知防止  

### 3.3 注文処理
- **Paperモード**：内部約定処理、スリッページを反映  
- **Realモード**：bitFlyer成行注文を発注、数量・最小取引単位を自動調整  
- 注文結果（約定価格・数量・手数料）をログ保存  

### 3.4 ポジション管理
- 状態を `state.json` に保存し、再起動後も復帰可能とする  
- 項目例：position, entry_price, size, tp, sl, pnl_cum, streak_loss  
- 同時建玉は1つに制限  

### 3.5 損益管理
- 利確水準（+2%）・損切り水準（-3%）を自動判定  
- 決済時にPnLを算出し、累積値に反映  
- 日次の取引履歴・損益をCSV保存  

### 3.6 通知機能
- Slackに以下イベントを通知  
  - シグナル確定（GC検知）  
  - 新規エントリー（価格・数量・TP/SL設定）  
  - 決済完了（TP/SL理由、損益）  
  - 異常停止・エラー  
  - 日次サマリ（取引回数・勝率・損益）  

### 3.7 ロギング
- 取引所API呼び出しの結果・失敗理由をログ  
- トレードごとの損益記録（trades.csv）  
- 日次損益・ドローダウンをmetrics.csvに保存  

---

## 4. 非機能要件
- 言語：Python 3.12  
- 実行環境：AWS（SageMaker, Lambda, またはコンテナ実行環境）  
- API制限：bitFlyer APIのレートリミットを遵守、リトライ制御あり  
- 冪等性：再起動時に状態復帰可能（state.json管理）  
- セキュリティ：APIキーは環境変数またはParameter Storeで管理  

---

## 5. 処理フロー（1時間サイクル）

1. スケジューラ起動（例：毎時 HH:01）  
2. ロック取得 → `state.json` 読込  
3. 直近200本の1H足を取得 → CSV保存  
4. SMA計算 → GC判定  
5. 状態が **FLAT** かつ GC確定なら → 新規買い注文  
6. 状態が **LONG** なら → 現在価格でTP/SL到達判定  
7. 約定処理（paper/real）、`state.json` 更新  
8. Slack通知  
9. 日次サマリを23:59に送信  
10. 正常終了 → ロック解除  

---

## 6. 運用・保守要件
- **Paperモードで1週間以上の継続稼働テスト**を実施し、異常時の復帰を確認  
- API障害・Slack障害時は再試行し、失敗時は警告通知  
- 日次でログ・トレード履歴をバックアップ  
- 運用時はドローダウン上限・連敗上限を設定し、自動停止機能を有効化  

---

## 7. 成果物
- 実装コード一式（Python）  
- configファイル（YAML）  
- 運用ドキュメント（セットアップ手順、エラー時リカバリ手順）  
- テスト記録（paperモード動作確認）  
